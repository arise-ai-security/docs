# SEC-bench Analysis and Reproduction

## Objective
To reproduce the results of the SEC-bench paper, understand its internal architecture, and identify potential integration points for Claude Code.

---

## Current Status (as of 2025-10-24)

- **Rate Limiting:**  
  The `secb.preprocessor.project` script is encountering numerous rate limit errors during execution, causing significant delays. This may require code modification if it persists.

- **Docker Hub Discrepancy:**  
  A majority of the `oss-fuzz` datasets do not have corresponding images in the `hwiwonlee` Docker Hub repository referenced by the scripts.

- **Bug Fixes:**  
  Several minor but impactful bugs that halted execution have been identified and fixed.

---

## 1. Clone SEC-bench Repository
Clone the official repository to begin the setup.

```bash
git clone https://github.com/SEC-bench/SEC-bench.git
cd SEC-bench
````

---

## 2. Patch Incorrect Docker Hub Path

The repository currently references `secb.eval.base:latest`, but this tag does not exist, causing Docker pull errors.
The following command updates all Python files to use a valid, versioned tag.

```bash
find . -type f -name "*.py" -exec env LC_ALL=C sed -i '' 's/secb\.eval\.base:latest/secb.eval.base:20241001/g' {} +
```

---

## 3. Execute `command.sh`

The provided `command.sh` script automates the setup and data pipeline.
It performs the following steps in order:

### 3.1. Create Artifact Directories

* **Script:** `setup_dirs.sh`
* **Action:** Initializes the required directory structure under the `artifact/` directory.
  Creates:

  * `artifact/input`
  * `artifact/1-seed`
  * `artifact/2-report`
  * `artifact/3-project`

---

### 3.2. Download Vulnerability Dataset

* **Script:** `download_osv.sh`
* **Action:** Checks if the `artifact/input` directory is empty.
  If it is, downloads the complete OSV vulnerability dataset (`all.zip`, ~900 MB) from Google Cloud Storage, extracts its contents (JSON files for individual vulnerabilities) into `artifact/input`, and then removes the ZIP file.

---

### 3.3. Filter Dataset by Docker Hub Availability

* **Script:** `cleanup_input.sh`
* **Action:** Filters the downloaded OSV dataset to align with pre-built Docker images available on the `hwiwonlee` Docker Hub.
  Reads a list of valid repositories from `artifact/repos.json` (generated by `extract.sh`), scans all JSON files in `artifact/input`, and deletes any vulnerability data for projects not in this allow-list.

---

### 3.4. Run Python Preprocessing Pipeline

* **Script:** `run_pipeline.sh`
* **Action:** Executes the core data processing pipeline by running three Python modules in sequence.
  These scripts take the raw JSON data from the input directory and progressively refine it into the final dataset used for evaluation.

```bash
python -m secb.preprocessor.seed
python -m secb.preprocessor.report
python -m secb.preprocessor.project
```

---

## 4. Python Script Analysis

### 1. Preprocessor Module (Data Collection and Environment Setup)

#### `secb.preprocessor.seed`

**Role:** Extracts initial vulnerability metadata from the downloaded OSV/CVE database files.
**Rationale:**

* Collects potential CVE instances from 7,926 open-source projects.
* Extracts vulnerability descriptions, reference URLs, repository info, and performs language detection.

**Key Tasks:**

* Parse OSV database.
* Extract repository metadata.
* Detect languages (focus on C/C++).

---

#### `secb.preprocessor.report`

**Role:** Extracts bug reports from diverse platforms.
**Rationale:**

* Addresses the challenge: *“bug reports lack a common schema”* (33% ignore templates).
* Scrapes multiple platforms: GitHub Issues, RedHat Bugzilla, Chromium Tracker.
* Uses Selenium automation for platforms without APIs.

**Key Tasks:**

* Extract bug descriptions.
* Collect fix commit information.
* Filter for OSS-Fuzz projects.
* Narrow to 4,836 well-documented instances.

---

#### `secb.preprocessor.project`

**Role:** Generates project-specific configuration files to reproduce the vulnerability.
**Rationale:**

* Addresses the core challenge: *“reproducing vulnerabilities is highly environment-sensitive.”*
* Requires exact compiler flags, library versions, and OS.

**Key Tasks:**

* Generate Dockerfiles based on OSS-Fuzz configs.
* Generate build scripts.
* Configure sanitizers (ASan, MSan, etc.).
* Filter to 898 candidate instances with sanitizer reports.

---

#### `secb.preprocessor.build_base_images`

**Role:** Builds versioned base Docker images.
**Rationale:**

* Reproduces the build-tool environment from the vulnerability period.
* Aligns with Ubuntu release cycles (2017–2024).

**Key Tasks:**

* Generate `hwiwonlee/secb.base:*` images.
* Install build tools and dependencies.

---

#### `secb.preprocessor.build_instance_images`

**Role:** Builds per-vulnerability specialized Docker images.
**Rationale:**

* Provides isolated, reproducible environments per CVE.
* Used by the Builder Agent (81.7 % success rate).

**Key Tasks:**

* Generate `hwiwonlee/secb.x86_64.*` images.
* Include vulnerable codebase, build scripts, and harnesses.

---

(TBD)